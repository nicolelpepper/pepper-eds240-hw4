---
output: html_document
editor_options: 
  chunk_output_type: console
  
---

Salmon populations in California have faced significant challenges over the past century. Today, the States's remaining salmon populations continue to battle environmental challenges introduced by diversions and dams, which have led to decreased flows, decreased water quality, and increased water temperatures. From the 1890s to 1960s, the construction of dams transformed a once free-flowing rivers, estimated to have supported upwards of ___ million salmon. These barriers have restricted access and diverted water from migratory routes and spawning habitat, critical for their survival.

Winter-run Chinook salmon, native to the Sacramento river drainage, have been particularly hit hard by these environmental challenges, because they uniquely spawn during the hot summer months when river and ambient temperatures are often at their hottest. In the early 1990s winter-run chinook narrowly escaped extinction. Their persistent battle to survive, has inspired my infographic, *"An Upstream Battle for Winter Run Chinook in California"*. 

With this infographic, I wanted to explore the following questions:
1) How have dams impacted winter-run Chinook salmon habitat?
2) How has historic Chinook salmon abundance changed over time for winter-run chinook? (spoiler - winter run chinook salmon are on the endangered species list)
3) How does stream water temperature impact Chinook salmon abundance for winter-run salmon?

Data:

#### Salmon Habitat:


#### Abundance Data:
For Question #2, I got abundance data for salmon in California from (The Nature Conservancy)[https://casalmon.org/statewide-status/#all-species]. This dataset provides estimates for adult population size for a variety of salmon species, including winter-run chinook. 

#### Stream Temperature Data:
For Question #3,I got stream temperature data from https://cdec.water.ca.gov/dynamicapp/wsSensorData. I retrieved data from right below Keswick Dam, which is now a common spawning location for Chinook, since it is the furthest north reach that is accessible for fish. The dataset provides hourly stream temperature readings from 2020 - present.



# Inspiration

My inspiration for the look for the piece, I wanted to:





For my color palette, I chose blue and reddish-pink. The blue represents water and the river that is critical habitat for the salmon. The pink is inspired by Chinook salmon, who often take on a reddish-pink hue during spawning.

To begin my exploration I set up my workspace.
### Set Up Workspace
```{r}
#| code-summary: "Load Libraries"

# ---- Load libraries ----
library(here)
library(dplyr)
library(tidyverse)
library(janitor)
library(tidycensus)
library(terra)
library(sf)
library(tmap)
library(readxl)
library(ggstream)
library(tmap)
library(networkD3)
library(ggpubr)
library(tmap)
library(elevatr)
library(smoothr)

```



### Read in Project Data
```{r}
# ---- Read in Salmon population data ----
#salmon <- read.csv(here::here("data","salmon", "WDFW-Salmonid_Population_Indicators__SPI__Escapement_20250214.csv")) |>
  #  clean_names()

salmon_ca <- read_excel(here::here("data","salmon","State_of_Salmon_in_CA_083024.xlsx")) |> 
    clean_names()


# ---- Read in Chinook Habitat map data ----
ca_state <- st_read(here::here("data/California_State_Boundary/California_State_Boundary.shp")) |> smooth(method = "chaikin") #use smooth() to simplify geometries
river <- st_read(here::here("data/rivers/sac_river.shp")) |> st_union() |> smooth(method = "chaikin")
bay <- st_read(here::here("data/rivers/sac_bay_wr_chinook.shp")) |> smooth(method = "chaikin")
habitat <- st_read(here::here("data/salmon_habitat.shp")) |> smooth(method = "chaikin")
dams <- st_read(here::here("data/chinook_dams.shp"))


# Transform the CRS for all layers after reading them
ca_state <- st_transform(ca_state, st_crs(4326))
dams <- st_transform(dams, st_crs(4326)) %>% filter(NAME == "Keswick")
habitat <- st_transform(habitat, st_crs(4326))
bay <- st_transform(bay, st_crs(4326)) %>% st_make_valid()
river <- st_transform(river, st_crs(4326)) 



# ---- Read in Sacramento River temp data for Keswick Dam ----
kes_stream_temp <- read.csv(here::here("data","KWK_25_w_temp.csv")) %>%
  clean_names() %>%
  mutate(obs_date = as.Date(obs_date),
         day_of_year = yday(obs_date),
         year = year(obs_date),
         month = month(obs_date, label = TRUE)) %>%
  filter(year < 2025)


```



# Change in habitat.

Every year from November to August, winter-run Chinook, embark on an upstream journey from the San Francisco Bay up to as far as the Keswick Dam. It is estimated that 

travel up to ____ miles, to spawning grounds. Successful spawning, requires cold river temperatures, and once hatched the ___ make their way downstream travel down to the ocean where they often spend three years before returning to their birthplace to spawn. 

Up to (95% of historic habitat)[https://noaa.maps.arcgis.com/apps/MapJournal/index.html?appid=ceebefd9685143daa5bf30d5a7e0c7fa]

To communicate this I wanted to use a combination of graphs with a map to describe how habitat has changed and illustrate habitat loss.




```{r}

# ---- Create a map of Chinook Salmon Habitat in Northern California ---

ggplot() +
    
    # Load CA outline
    geom_sf(data = ca_state,
            fill = "#20566E",
            color = NA) + 
    
    # Load chinook habitat boundaries
    geom_sf(data = habitat,
            aes(fill = Class),
            fill = c("#FC90A9","#65D8FE"),
            color = c(alpha("#FC90A9", 0.6),
                      alpha("#65D8FE", 0.6)),
            alpha = 0.3) + 
    
    # Load Sacramento River
    geom_sf(data = river,
            color = "#65D8FE") +
    
    # Load SF Bay
     geom_sf(data = bay,
             fill =  "#004564",
             color = "#004564") +
    
    # Load Keswick Dam
    geom_sf(data = dams,
            color = "#FE6571") +
    
    # Add river annotation
    annotate("text",
             x = 1, y = 1, 
             label = "The Saramento River",
             color = "#65D8FE",
             fontface = "bold",
             size = 2.5) +
    
    # Define Albers Equal Area proj for California
    coord_sf(crs = st_crs(3311)) +
    
    # Define theme
    theme_void() + 
    theme(
        plot.background = element_rect(fill = "#004564")
        )

```



# Decline in abundance
To visualize the dramatic decline of their population, I chose to use a filled area chart and colored.
```{r,fig.asp=.5, out.width="100%"}

# --- Filled stream chart for winter-run salmon abundance ----

# Clean and filter data for winter run chinook
winter_salmon <- salmon_ca |>
    filter(c_name == "Chinook") |>
    filter(r_timing == "Winter-run Chinook") |>
    dplyr::group_by(y_end,
                    r_timing) |>
    dplyr::summarise(abun_estimate = sum(abun_estimate, na.rm = TRUE),
                     .groups = "drop") 

# Define plot
ggplot(data = winter_salmon,
       aes(x = y_end,
           y = abun_estimate,
           fill = r_timing)) +
    
    # Add stream geometry for salmon abundance over time
    geom_stream(type = "ridge") +
    
    # Define color scheme
    scale_fill_manual(values = "#65D8FE") +
    
    # Label y axis with K for thousands
    scale_y_continuous(labels = scales::label_number(scale = 1e-3,
                                                     suffix = "K"),
                        breaks = c(10e3, 30e3, 50e3)) +
    
    # ---- Add annotations ----

        # Add a bracket for increased delta release ----
        geom_segment(aes(x = 2000, xend = 2000,
                         y = 9500, yend = 11000),
                     color = "#65D8FE",
                     size = .25) +
        
        geom_segment(aes(x = 2006, xend = 2006,
                         y = 9500, yend = 11000),
                     color = "#65D8FE",
                     size = .25) +
        
        geom_segment(aes(x = 2000, xend = 2006,
                         y = 11000, yend = 11000),
                     color = "#65D8FE",
                     size = .25) +
    
    # Add red arrow for 1994 - population less than 200 ----
    annotate("text",
             x = 1993, y = 5000, 
             label = "↓",
             color = "#FC90A9",
             size = 8) +
    
    # Add population annotation for 1994
    annotate("text", x = 1993, y = 16000, 
             label = "Population Drops\nto less than 200",
             color = "white",
             size = 3,
             fontface = "bold") +
    
    # Add endangered annotation for 1994
    annotate("text", x = 1993, y = 10000, 
             label = "Put on the endangered\n species list",
             color = "white",
             size = 2.5) +
    
     # Add battle creek annotation for 2018
    annotate("text",
             x = 2018, y = 9000, 
             label = "↓",
             color = "white",
             size = 8,
             fontface = "bold") +
    
    # Add annotation for 2018
    annotate("text",
             x = 2018, y = 15000, 
             label = "20k juvenile Chinook\nreleased in Battle Creek",
             color = "white",
             size = 2.5) +
    
    # Add bracket annotation
    annotate("text",
             x = 2003, y = 15000, 
             label = "20% Increase\nin Delta Release",
             color = "white",
             size = 2.5) +
    
    labs(
        title = "In the 90s winter-run Chinook narrowly avoided extinction",
        y = "Estimated\nWinter-Run\nChinook\nAdult\nPopulation",
        fill = "Return Type") +
    
  # Define theme
  theme_minimal() +
  theme(
        plot.title = element_text(face = "bold",
                                  color = "white",
                                  size = 12),
        axis.text.x = element_text(size = 10,
                                   face = "bold",
                                   color = "white"),
        axis.text.y = element_text(size = 10,
                                   face = "bold",
                                   color = "white"),
        axis.title.y = element_text(size = 11,
                                    face = "bold",
                                    color = "white",
                                    angle = 0,
                                    vjust = .5),
        axis.title.x = element_blank(),
        panel.grid = element_blank(),
        axis.ticks = element_blank(),
        plot.background = element_rect(fill = "#004564",
                                       color = NA),
        legend.position = "none"
        )
    
```


```{r}
temp_palette <- c("#004564","#65D8FE", "#FC90A9","#E11847")
```



```{r}
# ---- Calculate average and max daily stream temperature ----
daily_avg_temp_kes20 <- kes_stream_temp %>%
  group_by(day_of_year, year) %>%
  summarise(avg_temp = mean(value, na.rm = TRUE),
            max_temp = max(value, na.rm = TRUE)) %>%
  ungroup()
```


```{r, fig.asp=.5, out.width="100%"}

# Keswick heatmap of stream temperature by day of year facet by year 
ggplot(daily_avg_temp_kes20,
       aes(x = day_of_year,
           y = factor(year),
           fill = max_temp)) +
    
  geom_tile() +
    
        
 coord_cartesian(
         #xlim = c(2010, 2016),
          #        ylim = c(11, 0.25),
                  clip = "off") +
     
  # Add a box around April 15 to August 31
  geom_rect(aes(xmin = as.numeric(strptime("04-15", "%m-%d")$yday),
                xmax = as.numeric(strptime("08-31", "%m-%d")$yday),
                ymin = -Inf,
                ymax = Inf),
            color = "#D5FFFD",
            fill = NA,
            size = 1.5) +
    
  # Add a small rectangle below the spawning season box with the label "Spawning Season"
  geom_rect(aes(xmin = as.numeric(strptime("04-15", "%m-%d")$yday),
                xmax = as.numeric(strptime("08-31", "%m-%d")$yday),
                ymin = 0,  # Increase ymin to make the rectangle taller
                ymax = .4), # Adjust ymax to create the desired height
            fill = "#D5FFFD",
            color = "#D5FFFD",
            size = 1) +
    
  geom_text(aes(x = (as.numeric(strptime("04-15", "%m-%d")$yday + 1) + 
                     as.numeric(strptime("08-31", "%m-%d")$yday + 1)) / 2,
                y = 0.25,
                label = "Spawning Season: Apr. 1 - Aug. 31"),
            color = "#004564",
            fontface = "bold",
            size = 3) +
    
    scale_fill_gradientn(colors = temp_palette) +
    scale_y_discrete(limits = rev(levels(factor(daily_avg_temp_kes20$year)))) +  
    
  labs(title = "Daily maximum river temperature below Keswick Dam.") +
  theme_void() +
  theme(plot.title = element_text(color = "white",
                                  face = "bold",
                                  size = 16),
        axis.text.y = element_text(color = "white",
                                   face = "bold",
                                   size = 20), 
        axis.ticks.y = element_blank(),
        plot.background = element_rect(fill = "#004564",
                                       color = NA),
        legend.text = element_text(color = "white",
                                   size = 12),
        legend.title = element_blank(),
        legend.position = "top",
        legend.justification = c(1, 1))
```

```{r}
# ---- Calculate days exceeding the threshold of 53.3°F ----
threshold <- 53.3  # Threshold temperature for spawning

# Flag days where any hourly recording exceeds the threshold
daily_exceedance <- kes_stream_temp %>%
  group_by(year, month, obs_date) %>%
  summarise(exceed_threshold = as.integer(any(value > threshold, na.rm = TRUE))) %>%
  ungroup()

```


```{r}
# ---- Filter data for spawning season (April - August) ----
spawning_exceedance <- daily_exceedance %>%
  filter(month %in% c("April", "May", "June", "July", "August")) %>%
  group_by(year) %>%
  summarise(exceed_days = sum(exceed_threshold),
            total_days = n()) %>%
  mutate(non_exceed_days = total_days - exceed_days) %>%
  pivot_longer(cols = c(exceed_days, non_exceed_days), 
               names_to = "exceed_type", 
               values_to = "days") %>%
  mutate(proportion = days / total_days)

# Print the prepared data to check
head(spawning_exceedance)

```



```{r}

# ---- Calculate days exceeding the threshold of 53.3°F ----
threshold <- 53.3  # Threshold temperature for spawning

# Flag days where any hourly recording exceeds the threshold
daily_exceedance <- kes_stream_temp %>%
  group_by(year, month, obs_date) %>%
  summarise(exceed_threshold = as.integer(any(value > threshold, na.rm = TRUE))) %>%
  ungroup()

# ---- Filter data for spawning season (April - August) ----
spawning_exceedance <- daily_exceedance %>%
  filter(month %in% c("Apr", "May", "Jun", "Jul", "Aug")) %>% 
  group_by(year) %>%
  summarise(exceed_days = sum(exceed_threshold),
            total_days = n()) %>%
  mutate(non_exceed_days = total_days - exceed_days) %>%
  pivot_longer(cols = c(exceed_days, non_exceed_days), 
               names_to = "exceed_type", 
               values_to = "days") %>%
  mutate(proportion = days / total_days)

# ---- Stacked bar chart showing exceedance proportion per year with conditional labels ----
ggplot(spawning_exceedance, aes(y = factor(year,
                                           levels = rev(unique(year))), 
                                x = proportion, 
                                fill = exceed_type)) +
  geom_bar(stat = "identity",
           color = "white",
           size = 0.5) +
  
  # Add white bold text labels showing the rounded percentage if it is >= 5%
  geom_text(aes(label = ifelse(round(proportion * 100) >= 15, 
                               paste0(round(proportion * 100), "%"), 
                               "")),
            position = position_stack(vjust = 0.5), 
            color = "white", 
            fontface = "bold",
            size = 12) +
  
  scale_fill_manual(name = "Temperature Status", 
                    values = c("exceed_days" = "#F94B74", 
                               "non_exceed_days" = "#20566E"),
                    labels = c("Exceeded Threshold", "Did Not Exceed")) +
  scale_x_continuous(labels = scales::percent) +
  labs(title = "Percent of spawning season days that
met and exceeded the threshold") +
    
  theme_minimal() +
    
  theme(plot.title = element_text(face = "bold",
                                  color = "white",
                                  size = 20,
                                  hjust = 0.5),
        
        axis.text.x = element_blank(),
        axis.text.y = element_blank(),
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        panel.grid = element_blank(),
        axis.ticks = element_blank(),
        plot.background = element_rect(fill = "#004564", color = NA),
        legend.position = "none")

```


```{r}
# Define chinook population proportion
pop_prop <- data.frame(
  category = c("Remaining", "Historic Pop"),
  value = c(4, 96)
)

# Create the donut chart
ggplot(pop_prop, aes(x = 2,
                     y = value,
                     fill = category)) +
    
  geom_bar(stat = "identity",
           width = 1,
           color = "white") +  
    
  coord_polar("y", start = 0) +

  # Define width and height of chart
  xlim(0.2,
       2.5) +
    
  scale_fill_manual(values = c( "#E11847", "#65D8FE")) +
  labs(title = "Only 4% of Historic Population Remains") +
    
  theme_void() +

  theme(
    plot.title = element_text(face = "bold",
                              color = "white",
                              size = 16,
                              hjust = 0.5),
    
    panel.grid = element_blank(),
    axis.ticks = element_blank(),
    plot.background = element_rect(fill = "#004564",
                                   color = NA),
    legend.position = "none"
  ) 
```

```{r}
# Define habitat proportion
pop_prop <- data.frame(
  category = c("Remaining", "Historic Pop"),
  value = c(20, 80)
)

# Create the donut chart
ggplot(pop_prop, aes(x = 2,
                     y = value,
                     fill = category)) +
    
  geom_bar(stat = "identity",
           width = 1,
           color = "white") +
    
  coord_polar("y", start = 0) +

  # Define width and height of chart
  xlim(0.2,
       2.5) +
    
  scale_fill_manual(values = c( "#E11847", "#65D8FE")) +
  labs(title = "80% of historic spawning habitat\nis no longer accessible") +
    
  theme_void() +

  theme(
    plot.title = element_text(face = "bold",
                              color = "white",
                              size = 16,
                              hjust = 0.5),
    
    panel.grid = element_blank(),
    axis.ticks = element_blank(),
    plot.background = element_rect(fill = "#004564",
                                   color = NA),
    legend.position = "none"
  ) 
```